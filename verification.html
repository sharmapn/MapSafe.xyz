<!DOCTYPE html>

<html lang="en">
<head>

  <!-- Basic Page Needs
  ================================================== -->
  <meta charset="utf-8">
  <title>MapSafe | A Complete tool for Geospatial Data Sovereignty</title>

  <!-- Mobile Specific Metas
  ================================================== -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="description" content="Creative Agency Bootstrap Template">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
  <meta name="author" content="Themefisher">
  <meta name="generator" content="Themefisher Airspace Template v1.0">
  <!-- Favicon -->
  <link rel="shortcut icon" type="image/x-icon" href="images/logo.png" />



  <!-- Original scripts-->
  <!-- bootstrap.min css -->
  <link rel="stylesheet" href="plugins/bootstrap/bootstrap.min.css">
  <!-- Ionic Icon Css -->
  <link rel="stylesheet" href="plugins/Ionicons/css/ionicons.min.css">
  <!-- animate.css -->
  <link rel="stylesheet" href="plugins/animate-css/animate.css">
  <!-- Magnify Popup -->
  <link rel="stylesheet" href="plugins/magnific-popup/magnific-popup.css">
  <!-- Slick CSS -->
  <link rel="stylesheet" href="plugins/slick/slick.css">
  
  <!-- Main Stylesheet -->
  <link rel="stylesheet" href="assets/css/theme/style.css">

	
  <!-- My added scripts-->  
  <link rel="stylesheet" href="assets/css/ol.css" />   
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <script src="assets/js/multistep.js"></script>

  <script src="assets/js/skel.min.js"></script>
  <script src="assets/js/turf.min.js"></script>
  <script src="assets/js/shpwrite.js"></script>
  <script src="assets/js/ol.js"></script> 
  <script src="assets/js/shp.min.js"></script>
  <script src="assets/js/jszip.min.js"></script>
  <script src="assets/js/FileSaver.js"></script>
  <script src="assets/js/xyz.js"></script>
  <script src="assets/js/proj4.js"></script>
  <script src="assets/js/jquery.gifplayer.js"></script>
  <script src="assets/js/dstool.js"></script>						<!-- Encryption and Decryption -->
  <script src="assets/js/passphrase.js"></script> 				<!-- Generate passphrase for encryption -->
  <script src="assets/js/validation.js"></script> 				<!-- For validation, if layer or document -->
  
  
  <link href="https://fonts.googleapis.com/css?family=Poppins:400,600&display=swap" rel="stylesheet">
  <!-- <link rel="stylesheet" href="assets/css/multi-step/style2.css">	 maybe dont need on this page -->
  <link rel="stylesheet" href="assets/css/multi-step/multistepstyle.css"> 
  <!-- <link rel="stylesheet" href="assets/css/theme/multistepdemo.css"> -->
  
  <!-- h3binning  -->
  <script src="assets/js/geojson2h3.js"></script>	<!-- geojson2h3 created using browserify  -->
  <script src="https://unpkg.com/h3-js"></script>
  <script src="https://unpkg.com/h3-js@3.7.2/dist/h3-js.umd.js"></script>

  <!--  Mapbox Libraries for H3 Binning -->	
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@1.13.0-rc.4/dist/mapbox-gl.css" /> 
  <link rel="stylesheet" href="assets/css/binningMap.css" />  <!-- css style used for binning Map  -->
  <script src="https://unpkg.com/d3-fetch@2.0.0"></script>
  <script src="https://unpkg.com/maplibre-gl@1.13.0-rc.4"></script>
  <script src="https://unpkg.com/h3-js@3.7.0"></script>

  <!-- Icons and Tooltip -->
  <link rel="stylesheet" href="assets/css/info.css" /> 
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
   
  <script type="text/javascript">	
    window.addEventListener('load', function () 
    {			
		//initially hide binning map div
		var y = document.getElementById("mapContainer");
	    y.style.display = "none";		
	})	
  
	//Create sensitive data layer and add styling
	var sensitive = {
		style: new ol.style.Style({
			image: new ol.style.Circle({
				radius: 3,
				fill: new ol.style.Fill({
					color: '#FF8078'
				}),
				stroke: new ol.style.Stroke({
					color: 'black',
					width: .5
				})
			})
		}),
	};
	$(document).ready(function() {
		$("#downloadDecrypted").click(function(){
			//show the spinner			
			//console.log('Button clicked')
			var $this = $(this);
			decryptVolume();
			//$this.button('loading');
			//	setTimeout(function() {
				$this.button('reset');
			//}, 8000);
		}); 
	});

	
  </script>

  <!-- Main binning code -->		
  <script type="module" src="/assets/js/H3binning_verification.js">
	//import { update_map_centre } from '/assets/js/H3binning.js';
	//update_map_centre();
	//end of binning code 
  </script> 

  <!-- Matomo analytics captured to improve our tool. No data is stored on the cloud, as they are stoed on the MapSafe server.
	  Need to know 
	  - how much the tool is used, 
	  - if users are primarily using computers or mobile, 
	  - if sageguard and verification pages in their respective pages are used 
  -->
  <!-- Matomo analytics captured to improve our tool. Need to know if the tool is useful and in what way. -->
  <script>
    var _paq = window._paq = window._paq || [];
    /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
    _paq.push(['trackPageView']);
    _paq.push(['enableLinkTracking']);
    (function() {
      var u="//mapsafe.xyz/admin/matomo/";
      _paq.push(['setTrackerUrl', u+'matomo.php']);
      _paq.push(['setSiteId', '1']);
      var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
      g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
    })();
  </script>
  <!-- End Matomo Code -->

</head>

<body id="body">

<!-- Header Start -->
<header class="navigation">
	<div class="container">
		<div class="row">
			<div class="col-lg-12">
				<nav class="navbar navbar-expand-lg p-0">
					<a class="navbar-brand" href="index.html">
						<img src="images/logo_name.png" style="width:195px;height:50px;" alt="Logo">
					</a>

					<button class="navbar-toggler collapsed" type="button" data-toggle="collapse" data-target="#navbarsExample09" aria-controls="navbarsExample09" aria-expanded="false" aria-label="Toggle navigation">
						<span class="ion-android-menu"></span>
					</button>

					<div class="collapse navbar-collapse ml-auto" id="navbarsExample09">
						<ul class="navbar-nav ml-auto">
							<li class="nav-item @@home">
								<a class="nav-link" href="index.html">Home</a>
							</li>
							<li class="nav-item dropdown @@portfolio">
								<a class="nav-link dropdown-toggle" href="#" id="dropdown03" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Guides <span class="ion-ios-arrow-down"></span></a>
								<ul class="dropdown-menu" aria-labelledby="dropdown03">
									<li><a class="dropdown-item @@portfolioFilter" href="safeguarding-guide.html">Safeguarding Guide</a></li>
									<li><a class="dropdown-item @@portfolioSingle" href="verification-guide.html">Verification Guide</a></li>
									
								</ul>
							</li>
							<li class="nav-item @@service"><a class="nav-link" href="safeguard.html">Safeguard</a></li>
							<li class="nav-item @@service"><a class="nav-link" href="verification.html">Verification</a></li>
							
							<li class="nav-item @@contact"><a class="nav-link" href="contact.html">Contact</a></li>
							<li class="nav-item @@service"><a class="nav-link" href="disclaimer.html">Disclaimer</a></li>
						</ul>
					</div>
				</nav>
			</div>
		</div>
	</div>
</header><!-- header close -->

<section class="page-title bg-2"> 
  <div class="container">
    <div class="row">
      <div class="col-md-12"> 
        <div class="block" style="text-align:center;">
          <h1>Verification</h1> 		  
		  <p> The encrypted volume can be authenticated, decrypted and diplayed here.</p>
        </div>
      </div>
    </div>
  </div> 
</section>

<style>
	.multi_step_form #msform #progressbar li {
		list-style-type: none;		color: #99a2a8;			font-size: 9px;							width: calc(100%/4);  /* changed to allow only 4 tabs */
		float: left;				position: relative;		font: 500 13px/1 "Roboto", sans-serif;
	}
	
	input[type=text]{		width:72%; 	border:2px solid #aaa;	border-radius:4px;		margin:8px 0;		outline:none;		padding:8px;		box-sizing:border-box;		transition:.3s; 	}
  	input[type=text]:focus{		border-color:dodgerBlue;		box-shadow:0 0 8px 0 dodgerBlue;	}

	.multi_step_form #msform #progressbar li:nth-child(1):before {		content: "\f366";	}
	.multi_step_form #msform #progressbar li:nth-child(2):before {		content: "\f375";	}
	.multi_step_form #msform #progressbar li:nth-child(3):before {		content: "\f254";	}	
	.multi_step_form #msform #progressbar li:nth-child(4):before {		content: "\f38c";	}

</style>

<section class="service-about section">
	<div class="container">
		<div> 
			<div class="inner"> <!-- class="col-lg-6"> -->
				
				<!-- Start Multiform HTML -->
				<section class="multi_step_form">  
				<div id="msform"> 									  
					<ul id="progressbar">
						<li class="active">Load Encrypted Volume</li> <li>Verify</li> <li>Decrypt</li> <li>Display Map</li>
					</ul>
					<!-- fieldsets -->									
						<fieldset>
							<div>								
									<span class="tooltiptext">Load your encrypted file for verification. <br> Upon decryption, the map can be displayed. </a> </span></span><br><br>
								<!-- 19-10-21. The filevalidation function is also called fom inside the openFile function  -->
								<input type="file" id="encryptedInput" onchange='openFile(event)' accept=".enc" >
							</div><br>							

							<button type="button" id= "firstnextaction-button" class="next action-button" disabled>Continue</button>  
						</fieldset>
						<fieldset>										
							<p>The loaded encrypted volume has the following 256 SHA hash value. <br> To verify its originality, compare this with the hash stored on the blockchain.</p>														
									<code><output id=hashOutput>â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ</output></code><button id=copyHashBut>ðŸ“‹</button></span>								
								<br>								  								
							<br>
							<button type="button" class="action-button previous previous_button">Back</button>
							<button type="button" id="secondnextaction-button" class="next action-button">Continue</button>
						</fieldset>	
						<fieldset>
							<style>
								.button {
									background-color: #008cba; /* Green */
									border: none; color: white; padding: 15px 32px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer;
								}
								.button:disabled {	opacity: 0.5;	}
								.hide {				display: none;	}
							</style>
							<div id="ChooseVolumeToDecrypt" class="tabcontent2">
									Select level to decrypt into: &nbsp;
									<input type="radio" id="fine"         name="vol_decrypt" value="1"> 		<label for="fine">Fine&nbsp;</label>	
									<input type="radio" id="medium" 		name="vol_decrypt" value="2">	 <label for="medium">Medium&nbsp;</label>
									<input type="radio" id="coarse" 		name="vol_decrypt" value="3"  required >   	<label for="coarse">Coarse&nbsp;</label>
									<span class="msg" style="color:red;font-weight:bold"></span> <span class="icon2 fa-info-circle tooltip2"><span class="tooltiptext">Selecting fine decrypts the original dataset from the 1st level, medium decrypts the 2nd level holding the masked or binned dataset, while selecting coarse decrypts the 3rd level holding the heavily-masked or binned dataset. Check out the <a style="color: #a00808;" href="verification-guide.html#decryption" target="_blank">verification guide</a></span></span>		 										
									<br> 
							</div> 	

							<div id = "passphrasediv">
								<strong>Enter passphrase (5 terms for coarse level, 10 for medium, and 15 for fine)</strong>								
								<input id="txtDecpassphrase" type="text"  value="" width="500"> 
							</div>

							<button id="downloadDecrypted" type="button" style="margin: 0.5rem 0 .5rem 0; width: 36%;" class="buttondss buttondss6">  <i class="loading-icon fa fa-spinner fa-spin hide"></i> <span class="btn-txt-dec">Decrypt and Download Dataset</span>   </button>							
							<br>

							<button type="button" class="action-button previous previous_button">Back</button>
							<button type="button" id= "thirdNextAction-button" class="next action-button" disabled>Continue</button>  
							
						</fieldset>		
						<fieldset>
							<!-- Depending on the priviledge chosen during decryption, a corresponding level of detail of the original map is displayed here.-->
							Depending on chosen level a corresponding representation of the original map is displayed here <br>
							(refresh page/reopen browser if map is not displaying correctly).
							<div id="Displaying" class="tabcontent">											
								<div>			
									<button type="button" id="displayMap" class="buttondss buttondss6">  Display Map </button>
									<br><br>
								</div>
							</div>		

							<button type="button" class="action-button previous previous_button">Back</button>					
							<!-- <button type="button" a href="#" class="action-button" disabled>Finish</button> -->
							<button type="button" a href="https://mapsafe.xyz/" id="finish-button" class="action-button" disabled>Finish</button>
							
						</fieldset>					
				</div>   
				</section>				
			</div>
			
		</div>
		<!-- Map Display -->
		<article id="dm">	
			<!-- Openlayers map -->				
			<div id="map" style="height:50vh;"></div>	
			
			<div id="Binning" style="display: none;">
				<div>
					<span><strong>Binning</strong>: set the resolution for H3 binning, so the given point will be aggregated </span> <span class="icon fa-info-circle tooltip"><span class="tooltiptext"></span></span>
					<br>
					<div id="controlContainer"> 
						<label for="pointCloudsWeight">Resolution</label>
						<input id="hexResValue" type="range" min="0" max="1" step="any" value="0" />
						<label for="bufferRadius">Buffer Radius</label>
						<input id="bufferRadius" type="range" min="0" max="1" step="any" value="0" />										
					</div>
				</div>
				<br>				
				<button style="margin: 0.5rem 0 .5rem 0; width: 23%;" id="downloadBinned"  class="buttondss buttondss4" >Download Binned Data</button>
				<button style="margin: 0.5rem 0 .5rem 0; width: 23%;" id="clear" class="buttondss buttondss4" disabled>Clear All</button>
			</div> 
			<!-- Mapbox map -->
			<div id="mapContainer" style="height:50vh; width: 58vw; "> </div> 

		</article>	
	</div>
	
	<script>			
		//The Map!
		var map = new ol.Map({
			target: 'map',
			layers: [
				new ol.layer.Tile({
					source: new ol.source.XYZ({
						url:'https://basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}.png',
					})
				})
			],
			view: new ol.View({
				center: ol.proj.fromLonLat([-100, 45]),
				zoom: 3,
				maxZoom: 13
			})
		}); 		

		//upload their encrypted data and decrypt it.		
		function decryptVolume()
		{	
			console.log("Decryption: ");			
			//make sure users choose an option																						
			var valid = false,
			$options = $('.tabcontent2 input[name=vol_decrypt]'),
			$message = $('.tabcontent2 span.msg');

			$options.each(function (index) {
				var checked = $(this).prop('checked');
				//alert($(this).prop('checked'));
				if (checked) {
					valid = true;
					return false;
				}
			});

			if (!valid) {				
				$message.text('    Please choose one option');
				return;
			}
			
			$message.text('');
			//get level to decrypt											
			var levelToDecTo = document.querySelector('input[name="vol_decrypt"]:checked').value;
			//when the most inner layer is selected for decryption, we show the original map in openlayers
			levelToDec_global = levelToDecTo;
			console.log('level to decrypt = ' + levelToDecTo);
			
			var passphrase = document.getElementById("txtDecpassphrase");
			if (passphrase.value.trim() == ""){
				//make the enter passphrse text color to red
				var element = document.getElementById("passphrasediv");
        		element.style.color = "#FF0000";	
				return;
			}

			//show the spinner 
			$(".loading-icon").removeClass("hide");
			$(".button").attr("disabled", true);
			$(".btn-txt-dec").text("Decrypting...");	

			var startTimeDEC = new Date();
			console.log("Multi Level Decryption: Started " + startTimeDEC);

			// Start decrypting from level 3 (outer level) and this function starts decrypting from there
			// first 5 terms of passphrase is attempted, if its not decrypted, it means the outer level does not exist, 
			// second, it automatically goes on to try decrypting with 10 terms
			// same happens for the third
			// note, have to check if its only one level encrypted, and user wants to decryt to level 2, then show message										
			decryptedData = multiLevelDecrypt(objFile, levelToDecTo, currentLevel = 3, false, startTimeDEC);

			document.getElementById("thirdNextAction-button").disabled = false;				
		}

		//Adds a geojson layer to the map, using the selected OpenLayers style
		toMap2 = function(sourceGeoJSON, styleChoice) {
				delete sourceGeoJSON.layer;
				//map.removeLayer(sourceGeoJSON.layer);
				var source = new ol.source.Vector({
					features: (new ol.format.GeoJSON()).readFeatures(sourceGeoJSON, { featureProjection: 'EPSG:3857' })
				});
				sourceGeoJSON.layer = new ol.layer.Vector({
					zIndex: 9,
					renderMode: 'image',
					source: source,
					style: styleChoice
				});
				map.addLayer(sourceGeoJSON.layer);        
				var extent = sourceGeoJSON.layer.getSource().getExtent();        
				console.log('extent:' + extent)
				map.getView().fit(extent, { size: map.getSize(), maxZoom: 13 });
		}

	</script>
	
	<script type="text/javascript">
		$('.btn-spinner-example').click(function() {
		var btn = $(this);
		$(btn).buttonLoader('start');
		setTimeout(function() {
			$(btn).buttonLoader('stop');
		}, 3000);
		});
	</script> 


</section>

<!-- footer Start -->
<footer class="footer">
	<div class="container">
		<div class="row">
			<div class="col-md-12">
				<div class="footer-manu">
					<ul>
						<li><a href="contact.html">Contact us</a></li>
						<li><a href="faq.html">FAQ</a></li>
						<li><a href="disclaimer.html">Disclaimer</a></li>
					</ul>
				</div>
				<p class="copyright mb-0">Copyright <script>document.write(new Date().getFullYear())</script> &copy; Designed & Developed by <a
						href="http://www.themefisher.com">Themefisher</a>. All rights reserved.
					<br> Get More <a href="https://themefisher.com/free-bootstrap-templates/">Free Bootstrap
						Templates</a>
				</p>
			</div>
		</div>
	</div>
</footer>

<!--Scroll to top-->
<div id="scroll-to-top" class="scroll-to-top">
	<span class="icon ion-ios-arrow-up"></span>
</div>
	
	<!-- Our Scripts -->
	<script src="assets/js/jquery.scrollex.min.js"></script>
	<script src="assets/js/jquery.scrolly.min.js"></script>
	<script src="assets/js/browser.min.js"></script>
	<script src="assets/js/breakpoints.min.js"></script>
	<script src="assets/js/util.js"></script> 
	<script src="assets/js/main.js"></script>  <!--maybe dont need-->
	<script src="assets/js/main2.js"></script> <!--maybe dont need-->  <!-- second HTML5 Template -->	
	
				
	<script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js'></script>
	<!-- Not to be included in Geonode- It has its own version of Popper.js and conflicts with their login popup.-->>
	<script src='https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js'></script> 
	<script src='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-beta/js/bootstrap.min.js'></script>  
	<script src='https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.3/jquery.easing.min.js'></script> 
	<script src='https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/12.1.2/js/intlTelInput.js'></script>
	<script src='https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js'></script> 
	<script src='https://cdnjs.cloudflare.com/ajax/libs/jquery-nice-select/1.1.0/js/jquery.nice-select.min.js'></script>
	<!-- <script src='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css'></script> -->
	<script src="assets/js/multistep.js"></script>	
</body>
</html>